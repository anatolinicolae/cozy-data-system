// Generated by CoffeeScript 1.10.0
var application, log, startPouchDB;

log = require('printit')({
  prefix: 'Cozy Data System (dev mode)',
  date: true
});

startPouchDB = function(callback) {
  var PouchDB, app, express;
  express = require('express');
  app = express();
  PouchDB = require('pouchdb');
  app.use('/', require('express-pouchdb')(PouchDB));
  return app.listen(5984, callback);
};

application = module.exports = function(opts, callback) {
  var americano, errorMiddleware, initialize, root;
  if (opts == null) {
    opts = {};
  }
  root = opts.root || __dirname;
  process.env.INDEXES_PATH = opts.defaultDir;
  americano = require('americano');
  initialize = require('./server/initialize');
  errorMiddleware = require('./server/middlewares/errors');
  return startPouchDB(function(err) {
    var db;
    if (err) {
      log.error("Something, went wrong, it cannot start PouchDB server.");
      return log.error(err);
    } else {
      db = require('./server/lib/db');
      return db(function() {
        var options;
        options = {
          name: 'data-system',
          port: process.env.PORT || 9101,
          host: process.env.HOST || "127.0.0.1",
          root: root
        };
        return americano.start(options, function(err, app, server) {
          app.use(errorMiddleware);
          return initialize(app, server, callback);
        });
      });
    }
  });
};

if (!module.parent) {
  application();
}
